---
title: Token ring и виртуальные нод
author: Дмитрий Шупляков
tags: Cassandra
date: 2017-03-18 22:21:10
---
Как распределяются данные между нодами. На какую ноду попадут данные при записи? К какой ноде обращаться при чтении? Как происходит ребалансинг?

<!-- more -->

## Token Ring
Все данные, находящиеся в кластере, равномерно распределяются между нодами. Чтобы определить какими данными должна владеть нода, в Кассандре строится кольцо, это кольцо разбивается на интервалы и каждой ноде назначается свой диапазон. Кольцо называется Token ring и представляет собой числовой диапазон. Размер диапазона зависит от алгоритма хеширования, например для алгоритма murmur, он составляет от -2^63 до 2^63.

Во время вставки данных, Кассандра вычисляет хеш от первичного ключа (primary key) и по token ring определет в какую ноду нужно записывать данные. 

При чтении, Кассандре необхдимо выполнить аналогичный процесс, посчитать хеш от первичного ключа и опеределить с какой ноды читать. Именно по это причине при конструировании SELECT запросов в них обязательно должен быть указан первичный ключ. В противном случае Кассандре пришлось бы выполнять широковещательный запрос на все ноды, в надежде найти данные на какой-то из них. С точки зрения производительности - это чрезывачайно неэффективный процесс, поэтому запросы без указания первичного ключа - запрещено.

![cassandra-token-ring.png]({{ site.baseurl }}/images/7-chapter-token-ring.png)

## Виртуальные ноды (vnodes)
Виртуальные ноды или vnodes - способ улучшить перебалансировку данных между нодами. Если при перебалансировке опираться только на token ring, то при добавлении новой ноды потребуется переместить значительно больше данных, чем требуется. Это вызвано тем, что интервалы владения данными высчитыывают заново (с учетом новой ноды) и смещаются. Идея виртуальных нод заключаетя в том, чтобы добавить новый уровень абстракции между маппингом token ring на ноды. Этот слой содержит виртуальные ноды, добавляя дополнительную гранулярность данным. По умолчанию создается 256 таких виртуальных нод, которые распределяются между реальными нодами. При добавлении новой ноды в кластер, каждая существующая делится своими виртуальными нодами с новыми участником. Таким образом глобального перераспределения данных не происходит, что снижает пересылку данных по сети и ускоряет ввод новых нод. 

### Ссылки
1. https://www.datastax.com/dev/blog/virtual-nodes-in-cassandra-1-2
