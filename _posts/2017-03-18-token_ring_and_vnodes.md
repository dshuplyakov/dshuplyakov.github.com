---
title: Cassandra. Часть 3. Token ring & vnodes
author: Dmitry Shuplyakov
tags: Cassandra
date: 2017-03-18 22:21:10
---
Как распределяются данные между нодами. На какую ноду попадут данные при записи? К какой ноде обращаться при чтении? Что происходит с данными при добавлении/удалении ноды из кластера?

<!-- more -->

## Token Ring
Все данные, находящиеся в кластере, равномерно распределяются между нодами. Чтобы определить какими данными должна владеть нода, в Кассандре строится кольцо, это кольцо разбивается на интервалы и каждой ноде назначается свой диапазон. Кольцо называется Token ring и представляет собой числовой диапазон. Размер диапазона зависит от алгоритма хеширования, например для алгоритма murmur, он составляет от -2^63 до 2^63.

Во время вставки данных, Кассандра вычисляет хеш от первичного ключа (primary key) и по token ring определяет в какую ноду нужно записывать данные. 

При чтении, Кассандре необходимо выполнить аналогичный процесс, посчитать хеш от первичного ключа и определить с какой ноды читать. Именно по этой причине при конструировании CQL запросов в них обязательно должен быть указан первичный ключ. В противном случае, Кассандре пришлось бы выполнять широковещательный запрос на все ноды, в надежде найти данные на какой-то из них. С точки зрения производительности - это неэффективно, поэтому запросы без указания первичного ключа - запрещены. 

Что будет если одна из нод выйдет из строя? Допустим у нас есть кластер из 6 нод с Replication Factor = 3. 
 - диапазоном данных С владется нода 3, и копии данных лежат на нодах 4 и 5
 - диапазоном данных D владется нода 4, и копии данных лежат на нодах 5 и 6
 - диапазоном данных E владется нода 5, и копии данных лежат на нодах 6 и 1
 
 Если нода 5 откажет, то обрабатывать запросы по ее данным будут ноды 1, 3 и 4. Нода 2 не будет принматься участия в этом, т.к. на ней нет нужных данных. Нода 6 тоже - потому что диапазон данных (Е) уже обрабатывает нода 1. Таким образом, при отказе одной ноды, ее нагрузка распределяется на 3 других ноды. 

![token_ring_in_cassandra.png]({{ site.baseurl }}/images/token_ring_in_cassandra.png)

## Виртуальные ноды (vnodes)

В случае виртуальных нод - каждая нода делит свой интервал на n частей, которые называются виртуальными нодами. Далее виртуальные ноды распределяются случайным образом по всем машинам в кластере. Сколько копий виртуальных нод будет лежать на других машинах определяет Replication Factor. При отказе одной ноды, данные, которыми она владела лежат на всех машинах, поэтому нагрузка распределяются на все ноды. 

Вернувшись к нашему примеру, видно что в схеме в vnod'ами при отказе ноды 5, все остальные ноды будут стримить ее данные. Таким образом подход с vnode'ами позволяет размазать нагрузку по кластеру.

![vnodes_in_cassandra.png]({{ site.baseurl }}/images/vnodes_in_cassandra.png)

Количество данных, которое пересылается по сети в случае token ring  и vnode - одинаковое. 
Основные плюсы vnode:
- при отказе/добавлении ноды, ручная перебалансировка данных не требуется (т.к. нет значительного перекоса по данным)
- при отказе ноды ее данные стримят все ноды кластера

Важно: за число виртуальных нод отвечает параметр num_tokens в файле cassandra.yaml и по умолчанию он равен 256. Такое большое значение неоправдано и влияет на производительность:  растет число SSTable,  дольше выполняется repair, увеличивается использование CPU. Компания thelastpickle.com, специализирующаяся на OpenSource Cassandra рекомендуют установить num_tokens=4. Другая серьезная компания, успешно разрабатывающая собственный форк Кассандры - Datastax, рекомендует устанавливать это число равное 8 (и кстати планирует в будущем сделать его по умолчанию). Изменить количество виртуальных нод в существующем кластере не получится, поэтому задать их число нужно ДО инициализации кластера.

### Ссылки
1. https://www.datastax.com/dev/blog/virtual-nodes-in-cassandra-1-2
2. https://stackoverflow.com/questions/38423888/significance-of-vnodes-in-cassandra
3. http://thelastpickle.com/blog/2019/01/30/new-cluster-recommendations.html
