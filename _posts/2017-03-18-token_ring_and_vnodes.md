---
title: Token ring & Vnodes
author: Dmitry Shuplyakov
tags: Cassandra
date: 2017-03-18 22:21:10
---
Как распределяются данные между нодами. На какую ноду попадут данные при записи? К какой ноде обращаться при чтении? Как происходит ребалансинг?

<!-- more -->

## Token Ring
Все данные, находящиеся в кластере, равномерно распределяются между нодами. Чтобы определить какими данными должна владеть нода, в Кассандре строится кольцо, это кольцо разбивается на интервалы и каждой ноде назначается свой диапазон. Кольцо называется Token ring и представляет собой числовой диапазон. Размер диапазона зависит от алгоритма хеширования, например для алгоритма murmur, он составляет от -2^63 до 2^63.

Во время вставки данных, Кассандра вычисляет хеш от первичного ключа (primary key) и по token ring определяет в какую ноду нужно записывать данные. 

При чтении, Кассандре необходимо выполнить аналогичный процесс, посчитать хеш от первичного ключа и опеределить с какой ноды читать. Именно по этой причине при конструировании SELECT/UPDATE/DELETE запросов в них обязательно должен быть указан первичный ключ. В противном случае, Кассандре пришлось бы выполнять широковещательный запрос на все ноды, в надежде найти данные на какой-то из них. С точки зрения производительности - это неэффективно, поэтому запросы без указания первичного ключа - запрещены. 

## Виртуальные ноды (vnodes)
Что будет если одна из нод выйдет из строя? Допустим у нас есть кластер из 6 нод с RF=3. 
 - диапазоном данных С владется нода 3, и копии данных лежат на нодах 4 и 5
 - диапазоном данных D владется нода 4, и копии данных лежат на нодах 5 и 6
 - диапазоном данных E владется нода 5, и копии данных лежат на нодах 6 и 1
 
 Если нода 5 откажет, то ее 

При добавлении ноды в кластер, ей необходимо встроиться в существующий token ring, и дождаться того, что остальные ноды поделились с ней данными. Каждая существующая нода должна решить какой кусочек данных она должна переслать на новой ноде. В кластере из 4ех нод распределение данных будет следующим: 

![token_ring_in_cassandra.png]({{ site.baseurl }}/images/token_ring_in_cassandra.png)

При добавлении 5 ноды, в первую очередь необходимо решить за какой кусочек token ring она теперь будет отвечать.
Так как интервалы token ring'a, которыми владеют ноды непрерывны, значит новая нода так же должна получить свой непрерывный интервал. Допусти новая нода встроится между 4 и 1 нодой. Выглядеть это будет вот так:

![vnodes_in_cassandra.png]({{ site.baseurl }}/images/vnodes_in_cassandra.png)

Из картинки видно, что интервалы сместиились и 4-ая нода отдала почти все свои данные. Да и остальные тоже не поскупились. И только первая нода отдала пятую часть своих данных что является логичным, потому что участников стало 5.

Чтобы улучшить перераспределение данных при добавлении/удалении нод, в Кассандре, еще в версии 1.2 было введено понятие vnode или виртуальная нода. Идея виртуальных нод следующая:
- каждая физическая нода получает свой диапазон данных из token ring. Изначально этот интервал неделимый;
- далее этот интервал делится на фиксированное число кусочков, это и есть виртуальная нода. По умолчанию их 256;
- при добавлении новой ноды, старая высчитает сколько кусочков (виртуальных нод) она должна отдать новой ноде и пересылает только их;
- аналогичным образом поступают и другие старые ноды, пересылая только некоторые кусочки;
- таким образом новая нода отщипывает по чуть-чуть данных от каждой старой ноды и фактически владеет уже не одним непрерывным интервалом из token ring. А 4-мя интервалами;

Такой подход позволяет переслать новой ноде только те данные, которые ей нужны. И как следствие уменьшить перемещение данных по сети и сократить время ребалансинга кластера при добавлении/удалении нод.

### Ссылки
1. https://www.datastax.com/dev/blog/virtual-nodes-in-cassandra-1-2
