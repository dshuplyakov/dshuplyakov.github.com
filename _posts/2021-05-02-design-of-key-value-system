---
title: Проектируем key-value БД
author: Дмитрий Шупляков
date: 2022-05-02 23:30:00
tags:
---

## Key-value хранилище

Key-value хранилище - это нереляционная база данных, которая хранит данные в виде пар ключ-значение. В качестве ключа используется некоторый уникальный 
идентификатор, по которому осуществуется доступ к ассоциированным данным - документу. В качестве документа могут использоваться строки, json-документы, списки и т.д.

К этому классу систем относятся: Redis, Memcache, Amazon DymanoDB, Cassandra, Couchbase.

### Требования к key-value БД.

Перед проектированием key-value БД опишем требования, которым она должна удовлетворять:

- Небольшой размер key-value пары, 10 KB.
- Отсутствие лимита на количество хранимых документов.
- Высокая доступность (high availability). Система отвечает быстро, даже при отказе нод.
- Горизонтальная масштабируемость.
- Атоматическая масштабируемость. Добавление/удаление нод прозрачно и не требует ручных действий.
- Настраиваемая консистетность (configurable cosistancy level).
- Низкий latency.


<!-- more -->
### Распределенная БД
Наиболее простым и очевидным способом будет спроектировать БД на основе хеш-мапы, которая будет целиком располагаться на одном сервере. Однако такая система 
не сможет горизононтально масштабироваться, переживать отказы и обеспечивать high avaliability. Хотя и сможет обеспечить низкий latency и будет простав в реализации. 
Поэтому мы будем рассматривать распределенную архитектуру. 

Любые распределенные система сталкиваются с проблемой CAP-теоремы. 

#### CAP-теорема

CAP-теорема утверждает, что распределенная система удовлетворяет только 2 из 3 свойств, и никогда не может поддерживать все 3 свойства:
Consistency - обеспечение консистетности данных
Availability - обеспечение доступности системы. Если система способная обрабатывать запросы при сетевом расщеплении, значит она обладает свойством Availability.
Partition Tolerance - устойчивость к сетевому расщеплению. Потеря связи между частями системы (нодами) называется сетевым разрывом.

Таким образом:
CAP-системы: не существует.
CA-системы обеспечивают конситентность и доступность, но не переживают потерю связи между нодами. К этой группе относят реляционные базы данных. Чаще всего несколько
серверов БД работают в режиме master-slave репликации.
CP - поддерживают консистентность и устойчивость к сетевому расщеплению. В случае сетевого разрыва, система перестает обрабатывать запросы, теряя доступность но сохраняя консистеность.
AP - при сетевом разрыве система продолжает работать, но теряет консистентность. Так, возможна ситуация, когда кластер разделяется на две изолированные группы узлов и 
продолжает работать. При восстановлении связи, возможно включения алгоритма разрешения конфликтов. 



