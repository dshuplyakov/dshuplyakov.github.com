---
title: Что хранится в Object Header 
author: Дмитрий Шупляков
tags: Java
date: 2019-02-09 23:00:00
---

У каждого объекта в java, помимо самих полей есть метаданные, которые называются object header.
Давайте разберемся, что именно там хранится. <!-- more --> 

Структура object header:  

 - klass pointer (4 байта на 32x, 8 байт на 64х)  
 - mark word (4 байта на 32x, 8 байт на 64х)  
      - identityHashCode  
      - lock  
      - длина (только для массивов)  
      
      
![java-mark-word]({{ site.baseurl }}/images/MarkWord.png)      
      
Пример для 32х систем (см. другие сочетания здесь https://gist.github.com/arturmkrtchyan/43d6135e8a15798cc46c)
```
|----------------------------------------------------------------------------------------|--------------------|
|                                    Object Header (64 bits)                             |        State       |
|-------------------------------------------------------|--------------------------------|--------------------|
|                  Mark Word (32 bits)                  |      Klass Word (32 bits)      |                    |
|-------------------------------------------------------|--------------------------------|--------------------|
| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |      OOP to metadata object    |       Normal       | 1)
|-------------------------------------------------------|--------------------------------|--------------------|
|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |      OOP to metadata object    |       Biased       | 2)
|-------------------------------------------------------|--------------------------------|--------------------|
|               ptr_to_lock_record:30          | lock:2 |      OOP to metadata object    | Lightweight Locked | 3)
|-------------------------------------------------------|--------------------------------|--------------------|
|               ptr_to_heavyweight_monitor:30  | lock:2 |      OOP to metadata object    | Heavyweight Locked | 4)
|-------------------------------------------------------|--------------------------------|--------------------|
|                                              | lock:2 |      OOP to metadata object    |    Marked for GC   | 5)
|-------------------------------------------------------|--------------------------------|--------------------|      
```
- identity_hashcode - хешкод объекта, вызывается лениво.  
- age - число пережитых сборок мусора объектом 4 бита => максимум может достигать 15  
- biased_lock - признак легкой блокировки на объект (true/false)  
- lock - 0 если это thin-блокировка, 1 - если это fat блокировка  
- ptr_to_lock_record - указатель на монитор в java
- ptr_to_heavyweight_monitor - указатель на монитор в ОС




1) Новый объект, в нем зарезервировано 25 байт на identityHashcode. Блокировка на объекте не вызывалась. Но если на объекте позвали identity hashcode, забайсить (biased) на него больше никогда будет нельзя.  
2) biased - легкая блокировка на уровне Java, используется если с объектом работает один поток. В этом случае захват происходит без накладных расходов.  
3) lightweight(thin) - блокировка на уровне Java, использует CAS операции для гарантирования эксклюзивного доступа при небольшом контеншене.  
4) fat(inflated lock) - блокировка на уровне ОС, используется мютекс операционной системы  
   
