---
title: Что хранится в Object Header 
author: Дмитрий Шупляков
tags: Java
date: 2019-02-09 23:00:00
---

У каждого объекта в java, помимо самих полей есть метаданные, которые называются object header.
Давайте разберемся, что именно там хранится. <!-- more --> 

Структура object header:  

 - klass pointer (4 байта на 32x, 8 байт на 64х)  
 - mark word (4 байта на 32x, 8 байт на 64х)  
      - identityHashCode  
      - lock  
      - длина (только для массивов)  
      
      
![java-mark-word]({{ site.baseurl }}/images/MarkWord.png)      

- Hashcode - хешкод объекта, вызывается лениво.  
- *Age* - число пережитых сборок мусора объектом 4 бита => максимум может достигать 15  
- Lock record address - указатель на монитор в java
- Monitor address - указатель на монитор ОС
- Forwarding address, etc - 
- Tread ID - id треда владеющего объектом. Используется при легкой (biased) блокировке.

     
Распределения по байтам для различных систем [здесь](https://gist.github.com/arturmkrtchyan/43d6135e8a15798cc46c)

##Описание состояний объекта:

1) Unlocked - новый объект, в нем зарезервировано 25 байт на identityHashcode. Блокировка на объекте не вызывалась. Но если на объекте позвали identity hashcode, забайсить (biased) на него больше никогда будет нельзя.  
2) Biased - легкая блокировка на уровне Java, используется если с объектом работает один поток. В этом случае захват происходит без накладных расходов.  
3) Light-weight lock (thin) - блокировка на уровне Java, использует CAS операции для гарантирования эксклюзивного доступа при небольшом контеншене.  
4) Marked for GC - объект не используется, GC может удалить его.
5) Heavy-weight lock (fat/inflated lock) - блокировка на уровне ОС, используется мютекс операционной системы  
   
